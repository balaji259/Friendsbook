<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home page</title>
    <link rel="stylesheet" href="./home.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <navbar>
        <div id="nav-left">
            <img src="logo.jpeg" alt="Friendsbook logo">
        </div>
        <div id="nav-right">
            <h1>friendsbook</h1>
            <p id="tagline">Be Social . Be Popular</p>
        </div>
    </navbar>

    <section>
        <div id="sec-left">
            <div id="sec-left-top">
                <button class="sec-left-button">
                    <img src="icons8-home.svg" class="icon"> Home
                </button>
                <button class="sec-left-button">
                    <img src="icons8-search.svg" class="icon"> Search
                </button>
                <button class="sec-left-button">
                    <img src="icons8-connections-64.png" class="icon"> Friends
                </button>
                <button class="sec-left-button">
                    <img src="icons8-comments-24.png" class="icon"> Chats
                </button>
                <button class="sec-left-button">
                    <img src="icons8-notifications-78.png" class="icon"> Notifications
                </button>
                <button class="sec-left-button">
                    <img src="download_profile.png" class="icon"> Profile
                </button>
            </div>
            <div id="sec-left-bottom">
                <button id="logout" onclick="{
                    localStorage.clear();
                    window.location.href = 'index.html';
                }">
                    <img src="logout.png" class="icon"> Logout
                </button>
            </div>
        </div>

        <div id="sec-middle">
            <div id="post-element">
                <form id="createPostForm" enctype="multipart/form-data">
                    <div class="post-input-container">
                        <textarea id="postContent" name="captionOrText" placeholder="What are you thinking?" rows="4"></textarea>
                        <div class="media-upload">
                            <label for="postMedia" class="media-upload-label">
                                <span>ðŸ“· Select Media</span>
                                <input type="file" id="postMedia" name="mediaContent" accept="image/*,video/*" />
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="post-btn">Post</button>
                </form>
            </div>
            <div id="user-posts"></div>
        </div>

        <div id="sec-right">
            <div id="sec-right-top">
                <img id="profilePic" src="" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 10px;">
            
                <p id="username">Username</p>
            </div>
            
            <div id="sec-right-bottom">
                Suggestions
            </div>
        </div>
    </section>

    <script>

    document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');

    if (!token) {
        alert('No token found. Please log in again.');
        return;
    }

    // Function to fetch and display user details
    async function fetchUserDetails() {
        try {
            const response = await fetch('/user/getdetails', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}` // Send token in Authorization header
                }
            });

            if (response.ok) {
                const data = await response.json();

                // Update the profile section with the fetched data
                document.getElementById('profilePic').src = data.profilePic || 'default-profile.png';
                // document.getElementById('fullname').textContent = data.fullname || 'No Name';
                document.getElementById('username').textContent = `@${data.username}`;
            } else {
                alert('Failed to fetch user details.');
            }
        } catch (error) {
            console.error('Error fetching user details:', error);
            alert('Error fetching user details');
        }
    }

    // Call the function to fetch user details
    fetchUserDetails();
});

        // Handle form submission
        document.getElementById('createPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = document.getElementById('createPostForm');
            const formData = new FormData(form);
            const token = localStorage.getItem('token');

            if (!token) {
                alert('No token found. Please log in again.');
                return;
            }

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const { userId } = JSON.parse(jsonPayload);
                
                formData.append('userId', userId);

                const response = await fetch('/posts/create', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Post created successfully!');
                    form.reset();
                    fetchPosts(); // Refresh posts
                } else {
                    alert('Failed to create post: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Error submitting form');
            }
        });

        // Fetch posts from the backend
        async function fetchPosts() {
            try {
                const response = await fetch('/posts/get');
            
                const posts = await response.json();
                console.log(posts);
                if (Array.isArray(posts)) {
                    displayPosts(posts);
                } else {
                    console.error('Unexpected data format:', posts);
                }
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }

        // Display posts on the page
        function displayPosts(posts) {
    const postsContainer = document.getElementById('user-posts');
    postsContainer.innerHTML = '';

    posts.forEach(post => {

        //added
        console.log(`post`);
        console.log(post); // Inspect the post object structure here
    // const userId = post.user && post.user._id;
    const userId = post.userId && post.userId._id;
    const postId = post.postId;
    console.log(`User ID: ${userId}, Post ID: ${postId}`);

    //till this


        const postElement = document.createElement('div');
        postElement.classList.add('post');

        const postHeader = document.createElement('div');
        postHeader.classList.add('post-header');

        const profilePic = document.createElement('img');
        profilePic.classList.add('profile-pic');
        profilePic.src = post.user?.profilePic || 'default-profile.png';
        profilePic.alt = post.user?.username || 'User';

        const username = document.createElement('p');
        username.classList.add('username');
        username.textContent = post.user?.username || 'Anonymous';

        postHeader.appendChild(profilePic);
        postHeader.appendChild(username);
        postElement.appendChild(postHeader);



        if (post.postType === 'text' && post.caption) {
    const caption = document.createElement('p');
    caption.textContent = post.caption;
    postElement.appendChild(caption);
} else if (post.postType === 'image' && post.content?.mediaUrl) {
    const image = document.createElement('img');
    image.src = post.content.mediaUrl;
    image.alt = 'Post Image';
    image.classList.add('post-image');
    postElement.appendChild(image);

    // Add caption below the image
    if (post.caption) {
        const caption = document.createElement('p');
        caption.textContent = post.caption;
        postElement.appendChild(caption);
    }
} else if (post.postType === 'video' && post.content?.mediaUrl) {
    const video = document.createElement('video');
    video.src = post.content.mediaUrl;
    video.controls = true;
    video.classList.add('post-video');
    postElement.appendChild(video);

    // Add caption below the video
    if (post.caption) {
        const caption = document.createElement('p');
        caption.textContent = post.caption;
        postElement.appendChild(caption);
    }
}


        // Post Footer with Like, Comment, and Share buttons
        const postFooter = document.createElement('div');
        postFooter.classList.add('post-footer');

        // Like Button
        const likeButton = document.createElement('button');
        likeButton.classList.add('post-btn', 'like-btn');
        likeButton.id = `like-button-${post.postId}`;
        likeButton.innerHTML = `<i class="fa fa-thumbs-up"></i> Like (${post.likesCount || 0})`;
        // likeButton.onclick = () => toggleLike(post.userId,post.postId, likeButton);
        // When creating the like button in `displayPosts` function:
        // const userId = post.userId && post.userId._id; 
likeButton.onclick = () => toggleLike(userId, post.postId, likeButton);

        postFooter.appendChild(likeButton);

        // Comment Button
        const commentButton = document.createElement('button');
        commentButton.classList.add('post-btn', 'comment-btn');
        commentButton.innerHTML = `<i class="fa fa-comment"></i> Comment (${post.comments.length || 0})`;
        commentButton.onclick = () => openCommentSection(post.postId);  // Open comment section
        postFooter.appendChild(commentButton);

        // Share Button
        const shareButton = document.createElement('button');
        shareButton.classList.add('post-btn', 'share-btn');
        shareButton.innerHTML = `<i class="fa fa-share"></i> Share (${post.shares || 0})`;
        shareButton.onclick = () => handleShare(post.postId);
        postFooter.appendChild(shareButton);

        // Append the footer to the post element
        postElement.appendChild(postFooter);

        // Comment section (initially hidden)
        const commentSection = document.createElement('div');
        commentSection.classList.add('comment-section');
        commentSection.id = `comment-section-${post.postId}`;
        commentSection.style.display = 'none';

        const commentForm = document.createElement('form');
        commentForm.classList.add('comment-form');
        commentForm.onsubmit = (e) => handleCommentSubmit(e, post.postId); // Handle form submit for comment

        const commentInput = document.createElement('input');
        commentInput.classList.add('comment-input');
        commentInput.type = 'text';
        commentInput.placeholder = 'Add a comment...';
        commentForm.appendChild(commentInput);

        const commentSubmit = document.createElement('button');
        commentSubmit.classList.add('comment-submit');
        commentSubmit.type = 'submit';
        commentSubmit.textContent = 'Post';
        commentForm.appendChild(commentSubmit);

        commentSection.appendChild(commentForm);

        // Display existing comments
        const commentsList = document.createElement('div');
        commentsList.classList.add('comments-list');
        post.comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.classList.add('comment');
            commentElement.innerHTML = `<strong>${comment.user.username}:</strong> ${comment.text}`;
            commentsList.appendChild(commentElement);
        });
        commentSection.appendChild(commentsList);

        // Append comment section to post element
        postElement.appendChild(commentSection);

        // Append the post to the container
        postsContainer.appendChild(postElement);
    });
}

// Function to toggle like status
// Function to toggle like status
async function toggleLike(userId, postId, likeButton) {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('No token found. Please log in again.');
        return;
    }

    try {
        const response = await fetch(`/posts/like/${userId}/${postId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        if (response.ok) {
            const updatedLikesCount = result.likesCount;
            likeButton.innerHTML = `<i class="fa fa-thumbs-up"></i> Like (${updatedLikesCount})`;
        } else {
            alert('Failed to toggle like.');
        }
    } catch (error) {
        console.error('Error toggling like:', error);
    }
}

//comments

// Function to create comment section
 function createCommentSection(post) {
    const commentSection = document.createElement('div');
    commentSection.classList.add('comment-section');
    commentSection.id = `comment-section-${post.postId}`;
    commentSection.style.display = 'none';

    const commentForm = document.createElement('form');
    commentForm.classList.add('comment-form');
    commentForm.onsubmit = (e) => handleCommentSubmit(e, post.postId); // Handle form submit for comment

    const commentInput = document.createElement('input');
    commentInput.classList.add('comment-input');
    commentInput.type = 'text';
    commentInput.placeholder = 'Add a comment...';
    commentForm.appendChild(commentInput);

    const commentSubmit = document.createElement('button');
    commentSubmit.classList.add('comment-submit');
    commentSubmit.type = 'submit';
    commentSubmit.textContent = 'Post';
    commentForm.appendChild(commentSubmit);

    commentSection.appendChild(commentForm);

    // Display existing comments
    const commentsList = document.createElement('div');
    commentsList.classList.add('comments-list');
    // console.log('comment is '+ comment);
    post.comments.forEach(comment => {
        // console.log('comment is '+ comment);
        const commentElement = createCommentElement(comment);
        commentsList.appendChild(commentElement);
    });
    commentSection.appendChild(commentsList);

    return commentSection;
}

// Function to create an individual comment element
function createCommentElement(comment) {
    const commentElement = document.createElement('div');
    commentElement.classList.add('comment');
    commentElement.innerHTML = `<strong>${comment.user.username}:</strong> ${comment.text}`;
    return commentElement;
}

// Function to toggle the comment section visibility
function openCommentSection(postId) {
    const commentSection = document.getElementById(`comment-section-${postId}`);
    commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
}

// Function to handle comment submission
async function handleCommentSubmit(e, postId) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) {
        alert('No token found. Please log in again.');
        return;
    }

    const form = e.target;
    const commentInput = form.querySelector('.comment-input');
    const commentText = commentInput.value.trim();

    if (!commentText) {
        alert('Comment cannot be empty.');
        return;
    }

    try {
    const response = await fetch(`/posts/comment/${postId}`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: commentText })
    });

    const result = await response.json();
    
    if (response.ok) {
        // Update comment section with the new comment
        const commentsList = form.closest('.comment-section').querySelector('.comments-list');
        
        // Create a comment element using the updated result structure
        const newCommentElement = createCommentElement(result);
        commentsList.appendChild(newCommentElement);

        // Clear the input field
        commentInput.value = '';

        // Scroll to the new comment
        newCommentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        alert(result.message || 'Failed to post comment.');
    }
} catch (error) {
    console.error('Error posting comment:', error);
    alert('An error occurred while posting the comment. Please try again.');
}

}




// Function to handle sharing
function handleShare(postId) {
    alert(`Post ${postId} shared!`);  // For now, just show an alert
}


       
        fetchPosts(); // Initial fetch to load posts
    </script>
</body>
</html>
